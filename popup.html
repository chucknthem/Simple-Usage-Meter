<style>
	body {
		min-width:150px;
		overflow-x:hidden;
	}
</style>
<script>

	/*
	 * nestpace isp
	 */
	 function netspace_parseXML(xml) { 
		 var enddatestr = xml.documentElement.getAttribute('END_DATE').split('-');

		 var today = new Date();
		 var enddate = new Date(enddatestr[2], enddatestr[1] - 1, enddatestr[0])
		 var daysleft = (enddate.getTime() - today.getTime())/(1000*60*60*24)


		 var limits = xml.getElementsByTagName("PLAN")[0].getElementsByTagName("LIMIT");
		 var data = xml.getElementsByTagName("TRAFFIC")[0].getElementsByTagName("DATA");
		 var results = new Array();
		 for(var i = 0; i < limits.length; i++) {
			 var limitName = limits[i].getAttribute("NAME");
			 var limitmb = limits[i].getAttribute("MEGABYTES");
			 var usagemb = data[i].getAttribute("DOWNLOADS");

			 results[i] = new Object();
			 results[i]['name'] = limitName;
			 results[i]['mbleft'] = (limitmb - usagemb);
			 results[i]['daysleft'] = Math.ceil(daysleft);
		 }

		 //xml version 4
		 //var limitmb = xml.getElementsByTagName("PLAN")[0].getElementsByTagName("MEGABYTES")[0].childNodes[0].nodeValue;

		 return results;
	 }
	 /*
	 * iiNet isp
	 */
	 function iiNet_parseXML(xml) {
		 //TODO	
	 }

	 /************************************************************
	 * 
	 *
	 ************************************************************/
	 function fetchAndDisplay(params) {
		 req = new XMLHttpRequest();

		 req.open("POST", params.getURL(), true);
		 req.onload = function() {
			 var data;
			 if(req.status == 200) {
				 data = params.parse(req.responseXML);
			 } else {
				 data = new Array();
				 data[0] = new Object();
				 data[0].error = "error" + req.status + ":failed to retrieve usage data, make sure your login information is correct.";
			 }
			 showUsage(data);
		 }
		 req.send(null);
	 }

	 function showUsage(data) {
		 var divEl = document.createElement("div");
		 if(data != null && !data[0].error) {
			 for(var i = 0; i < data.length; i++) {
				 var text = document.createElement("p");
				 text.innerHTML = '<b>' + data[i].name + '</b><br />';
				 text.innerHTML += data[i].mbleft + "Mb left";
				 divEl.appendChild(text);
			 }
			 var text = document.createElement("p");
			 text.innerHTML = "resets in " + Math.ceil(data[0].daysleft) + " days";
			 divEl.appendChild(text);
		 } else {
			 divEl.innerHTML = data[0].error;	
		 }
		 document.body.appendChild(divEl);
	 }

	 //data structure for isp login and xml parsing
	 function UsageParam(isp, username, password) {
		 this.error = null;
		 this.mbleft = 0;
		 this.daysleft=0;
		 this.isp = isp;
		 this.username = username;
		 this.password = password;
		 //list of known isp xml feeds
		 this.feeds = new Object();
		 this.feeds['netspace'] = "https://{USERNAME}:{PASSWORD}@usage.netspace.net.au/usage-meter/adslusage?version=3&granularity=MONTH";
		 this.feeds['iiNet']= "https://toolbox.iinet.net.au/cgi-bin/new/volume_usage_xml.cgi?username={USERNAME}&action=login&password={PASSWORD}";

		 this.getURL = function() {
			 return this.feeds[this.isp].replace('{USERNAME}', this.username).replace('{PASSWORD}', this.password);
		 }
		 //parse xml function for each ISP defined globally
		 this.parse = window[isp + "_parseXML"];
	 };


	 //main entry point
	 if(localStorage['isp']) {
		 params = new UsageParam(localStorage['isp'], localStorage['username'], localStorage['password']);
		 fetchAndDisplay(params);
	 } else {
		 var data = new Object();
		 data['error'] = "No account details, enter your ISP login details in the options";
		 showUsage(data);
	 }

 </script>
