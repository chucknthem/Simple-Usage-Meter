<style>
	body {
		min-width:150px;
		overflow-x:hidden;
	}
</style>
<script>
	function mkError(msg) {
		var error = new Array();
		error[0] = new Object();
		error[0].error = msg;
	}
	/*
	 * get topup limits for netspace plans
	 * @param name limit name
	 * @param limits array of xml LIMIT nodes with BLOCK child nodes
	 */
	function netspace_getBlockLimits(name, limits) {
		var limit = 0;

		for(var i = 0; i < limits.length; i++) {
			if(limits[i].getAttribute("NAME") == name) {
				var blocks = limits[i].getElementsByTagName("BLOCK");
				if(blocks) {
					for(var b = 0; b < blocks.length; b++) {
						limit += parseInt(blocks[b].getAttribute("MEGABYTES"));
					}
				}
			}
		}
		return limit;
	}
	/*
	 * nestpace isp
	 * @param xml root xml document with USAGE as the first node
	 */
	function netspace_parseXML(xml) { 
		var results = new Array();
		var enddatestr = xml.documentElement.getAttribute('END_DATE');

		if(!enddatestr) {

			return mkError("END_DATE not found. invalid XML");
		} 
		enddatestr = enddatestr.split('-');

		var today = new Date();
		var enddate = new Date(enddatestr[2], enddatestr[1] - 1, enddatestr[0])
		var daysleft = (enddate.getTime() - today.getTime())/(1000*60*60*24)


		//normal limits
		var plan = xml.getElementsByTagName("PLAN");
		if(!plan) {
			return mkError("PLAN not found. invalid XML");
		}

		var limits = plan[0].getElementsByTagName("LIMIT");
		if(!limits) {
			return mkError("LIMIT not found. invalid XML");
		}
		var traffic = xml.getElementsByTagName("TRAFFIC");
		if(!traffic) {
			return mkError("TRAFFIC not found. invalid XML");
		}
		var data = traffic[0].getElementsByTagName("DATA");
		if(!data) {
			return mkError("DATA not found. invalid XML");
		}
		var blockLimits = xml.getElementsByTagName("DATABLOCKS");
		if(blockLimits) {
      blockLimits = blockLimits[0].getElementsByTagName("LIMIT");
  }
		for(var i = 0; i < limits.length; i++) {
			var limitName = limits[i].getAttribute("NAME");
			var limitmb = parseInt(limits[i].getAttribute("MEGABYTES"));
			var usagemb = parseInt(data[i].getAttribute("DOWNLOADS"));

			if(blockLimits) {
				limitmb += netspace_getBlockLimits(limitName, blockLimits);
			}

			results[i] = new Object();
			results[i]['custom'] = false;
			results[i]['name'] = limitName;
			results[i]['usagemb'] = usagemb;
			results[i]['limit'] = limitmb;
			results[i]['daysleft'] = Math.ceil(daysleft);
		}

		//xml version 4
		//var limitmb = xml.getElementsByTagName("PLAN")[0].getElementsByTagName("MEGABYTES")[0].childNodes[0].nodeValue;

		return results;
	}
	/*
	* iiNet isp
	*/
	function iiNet_parseXML(xml) {
		var results = new Array();
		var daysRemainingNode = xml.getElementsByTagName("days_remaining");
		if(!daysRemainingNode) {
			return mkError("days_remaining not found: invalid XML");
		}
		var daysLeft = daysRemainingNode[0].childNodes[0].nodeValue;
		var types = xml.getElementsByTagName("type");
		if(!types) {
			return mkError("no plan types found: invalid XML");
		}
		for(var i = 0; i < types.length; i++) {
			results[i] = new Object();
			results[i]['name'] = types[i].getElementsByTagName("name")[0].childNodes[0].nodeValue;
			var quotaNode = types[i].getElementsByTagName("quota_allocation");
			if(quotaNode) {
				var limitmb = quotaNode[0].childNodes[0].nodeValue;
				var usagemb = types[i].getAttribute("used");
				usagemb /= 1024*1024*1024;
				
				results[i]['usagemb'] = usagemb;
				results[i]['limit'] = limitmb;
				results[i]['daysleft'] = daysLeft;
				results[i]['custom'] = false;
			}
		}
		
	}

	/************************************************************
	* 
	*
	************************************************************/
	function fetchAndDisplay(params) {
		req = new XMLHttpRequest();

		req.open("POST", params.getURL(), true);
		req.onload = function() {
			var data;
			if(req.status == 200) {
			
				data = params.parse(req.responseXML);
			} else {
				data = new Array();
				data[0] = new Object();
				data[0].error = "error " + req.status + ":failed to retrieve usage data, make sure your login information is correct.";
			}
			showUsage(data);
		}
		req.send(null);
	}

	function showUsage(data) {
		var divEl = document.createElement("div");
		if(data != null && !data[0].error) {
			for(var i = 0; i < data.length; i++) {
				var text = document.createElement("p");
				text.innerHTML = '<b>' + data[i].name + '</b><br />';
				text.innerHTML += (data[i].limit - data[i].usagemb) + "Mb left";
				divEl.appendChild(text);
			}
			var text = document.createElement("p");
			text.innerHTML = "resets in " + Math.ceil(data[0].daysleft) + " days";
			divEl.appendChild(text);
		} else {
			divEl.innerHTML = data[0].error;	
		}
		document.body.appendChild(divEl);
	}

	 //data structure for isp login and xml parsing
	function UsageParam(isp, username, password) {
		this.error = null;
		this.mbleft = 0;
		this.daysleft=0;
		this.isp = isp;
		this.username = username;
		this.password = password;
		//list of known isp xml feeds
		this.feeds = new Object();
		this.feeds['netspace'] = "https://{USERNAME}:{PASSWORD}@usage.netspace.net.au/usage-meter/adslusage?version=3&granularity=MONTH";
		this.feeds['iiNet']= "https://toolbox.iinet.net.au/cgi-bin/new/volume_usage_xml.cgi?username={USERNAME}&action=login&password={PASSWORD}";

		this.getURL = function() {
			return this.feeds[this.isp].replace('{USERNAME}', this.username).replace('{PASSWORD}', this.password);
		}
		//parse xml function for each ISP defined globally
		this.parse = window[isp + "_parseXML"];
	};


	//main entry point
	if(localStorage['isp']) {
		params = new UsageParam(localStorage['isp'], localStorage['username'], localStorage['password']);
		fetchAndDisplay(params);
	} else {
		var data = new Object();
		data['error'] = "No account details, enter your ISP login details in the options";
		showUsage(data);
	}

</script>
